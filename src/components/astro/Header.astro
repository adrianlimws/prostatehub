---
import MobileMenuButton from '../vue/MobileMenuButton.vue';
import Search from "astro-pagefind/components/Search";

// Get current URL path for highlighting active page
const currentPath = Astro.url.pathname;
---

<header class="bg-white fixed top-0 left-0 right-0 z-50 font-mono">
  <div class="flex flex-col w-full">
    <!-- Main header row -->
    <div class="flex items-center justify-between">
      <div class="font-bold text-xl uppercase"> 
        <a href="/" class={`px-2 py-7 bg-blue hover:bg-green text-white transition ${currentPath === "/" ? "bg-green transition" : ""}`}>Prostate Hub</a>
      </div>
      
      <!-- Desktop Navigation - Hidden on mobile -->
      <nav class="hidden md:flex items-center space-x-4 text-lg">
        <a href="/stage-0"        class={`p-2 rounded hover:underline transition ${currentPath === "/stage-0" ?        "bg-green text-white transition" : ""}`}>Stage 0</a>
        <a href="/stage-1"        class={`p-2 rounded hover:underline transition ${currentPath === "/stage-1" ?        "bg-green text-white transition" : ""}`}>Stage 1</a>
        <a href="/stage-2"        class={`p-2 rounded hover:underline transition ${currentPath === "/stage-2" ?        "bg-green text-white transition" : ""}`}>Stage 2</a>
        <a href="/stage-3"        class={`p-2 rounded hover:underline transition ${currentPath === "/stage-3" ?        "bg-green text-white transition" : ""}`}>Stage 3</a>
        <a href="/stage-4"        class={`p-2 rounded hover:underline transition ${currentPath === "/stage-4" ?        "bg-green text-white transition" : ""}`}>Stage 4</a>
        <a href="/family-support" class={`p-2 rounded hover:underline transition ${currentPath === "/family-support" ? "bg-green text-white transition" : ""}`}>Family Support</a>
        <a href="/studies"        class={`p-2 rounded hover:underline transition ${currentPath === "/studies" ?        "bg-green text-white transition" : ""}`}>Studies</a>
        <a href="/support-groups" class={`p-2 rounded hover:underline transition ${currentPath === "/support-groups" ? "bg-green text-white transition" : ""}`}>Support Groups</a>
      </nav>
      
      <!-- Search Button -->
      <div class="flex items-center">
        <button id="search-toggle" class="px-4 py-7 bg-blue text-white hover:bg-green transition">
          <span>Search</span>
        </button>
        
        <!-- Mobile Menu Button - Only visible on mobile -->
        <div class="md:hidden">
          <MobileMenuButton client:load />
        </div>
      </div>
    </div>
    
    <!-- Search Row - Hidden by default, shown when search is clicked -->
    <div id="search-container" class="hidden w-full pb-4 px-4">
      <div class="relative w-full">
        <Search id="search" className="pagefind-ui pagefind-ui--fullwidth" uiOptions={{ showImages: false }} />
      </div>
    </div>
  </div>
</header>

<div class="h-16"></div>

<script>
  // Show/hide search
  document.addEventListener('DOMContentLoaded', () => {
    const searchToggle = document.getElementById('search-toggle');
    const searchContainer = document.getElementById('search-container');

    searchToggle?.addEventListener('click', () => {
      if (searchContainer?.classList.contains('hidden')) {
        searchContainer.classList.remove('hidden');
        // Focus the search input
        setTimeout(() => {
          const searchInput = document.querySelector('.pagefind-ui__search-input');
          if (searchInput) {
            searchInput.focus();
          }
        }, 100);
      } else {
        searchContainer?.classList.add('hidden');
      }
    });

    document.addEventListener('click', (event) => {
      const target = event.target;
      
      // Don't close if click is inside search container
      const isClickInsideSearch = target.closest('#search-container') || target.closest('#search-toggle');
      
      // Don't close if click is on 'load more' button or other pagefind UI controls
      const isClickOnSearchControls = 
        target.closest('.pagefind-ui__button') || 
        target.closest('.pagefind-ui__result-link') ||
        target.closest('.pagefind-ui__result-title') ||
        target.closest('.pagefind-ui__result-excerpt') ||
        target.closest('.pagefind-ui__results-pagination') ||
        target.closest('.pagefind-ui__message');
        
      // Only close if it's a click outside the search area AND not on search UI controls
      if (!isClickInsideSearch && !isClickOnSearchControls && !searchContainer?.classList.contains('hidden')) {
        searchContainer?.classList.add('hidden');
      }
    }, { capture: true }); // Use capture to get the event before it propagates
  });
</script>

<style is:global>
  /* Style the pagefind UI for full width results */
  .pagefind-ui--fullwidth .pagefind-ui__drawer {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    background: #F4EDED;
    z-index: 100;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border-radius: 0 0 0.5rem 0.5rem;
    padding: 1rem;
  }

  .pagefind-ui--fullwidth .pagefind-ui__results-container {
    max-width: 100%;
  }

  .pagefind-ui--fullwidth .pagefind-ui__result {
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid #202020;
  }

  .pagefind-ui--fullwidth .pagefind-ui__message {
    padding: 1rem;
  }

  /* Customize search input */
  .pagefind-ui--fullwidth .pagefind-ui__search-input {
    margin: 1rem 0;
    padding: 0.75rem 2rem;
    border-radius: 0.375rem;
    border: 2px solid #d1d5db;
    width: 100%;
  }

  /* Make sure search form spans full width */
  .pagefind-ui--fullwidth .pagefind-ui__form {
    width: 100%;
  }
  
  /* Style for load more button */
  .pagefind-ui__button {
    background-color: #324Ea2;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .pagefind-ui__button:hover {
    background-color: #57B286;
  }
</style>